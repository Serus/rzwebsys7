(function(d){var c=function(e){this.params={size:0,ext:[]};d.extend(this.params,e)};c.prototype.getExt=function(f){var e=f.split(".");var g=e.pop();return g.toLowerCase()};c.prototype.validate=function(e){return this.validateSize(e)&&this.validateExt(e)};c.prototype.validateSize=function(e){if(this.params.size==0){return true}var f=this.params.size*1024*1024;if(e.size>f){return false}else{return true}};c.prototype.validateExt=function(e){var f=this.getExt(e.name);if(this.params.ext.length==0||d.inArray(f,this.params.ext)>-1){return true}else{return false}};var b=function(e){this.params=e};b.prototype.upload=function(){var h=this.params;var e=new XMLHttpRequest();if(e.upload&&e.upload.addEventListener){if(h.progressCallback){e.upload.addEventListener("progress",h.progressCallback,false)}e.onreadystatechange=function(){if(this.readyState==4){if(this.status==200){if(h.okCallback){h.okCallback.apply(this)}}else{if(h.errorCallback){h.errorCallback.apply(this)}}}};e.upload.addEventListener("error",function(i){alert("Ошибка при загрузке файла")})}var g=new FormData();g.append("path","/");for(var f=0;f<this.params.files.length;f++){g.append(this.params.fileName,this.params.files[f])}e.open("POST",this.params.url);e.send(g)};var a=function(e,g){this.params={uploadUrl:"/upload.php",maxFileSize:2,allowedExt:["jpg","jpeg","gif","png","pdf","doc","docx","xsl","xslx","odt","ppt","zip","rar","gz","tar","swf","csv"]};d.extend(this.params,g);this.input=e;this.form=e.parents("form");if(this.form.length==0){throw new Error("Виджет должен находится в форме")}var f=this.form.get(0);if(!f.uploadQueue){f.uploadQueue={}}if(!f.uploadValidators){f.uploadValidators={}}this.inputName=this.input.attr("name");f.uploadQueue[this.inputName]=[];f.uploadValidators[this.inputName]=new c({size:this.params.maxFileSize,ext:this.params.allowedExt});this.input.removeAttr("name");this.dropBox=e.next(".uploader-widget-drop-box");this.filesList=this.dropBox.find(".uploader-widget-files-list");this.bindEvents()};a.prototype.submitForm=function(e){if(!this.hasInQueue(e)){console.log(e);d(e).find("[type='submit']").attr("disabled",false);d(e).submit()}};a.prototype.hasInQueue=function(f){for(var e in f.uploadQueue){if(f.uploadQueue[e].length>0){return true}}return false};a.prototype.validateFiles=function(m){for(var g in m.uploadQueue){var l=m.uploadValidators[g];var f=m.uploadQueue[g];for(var j=0;j<f.length;j++){var e=f[j];var h=e.get(0).file;if(!l.validateExt(h)){alert("Недопустипый тип файла "+h.name);return false}if(!l.validateSize(h)){alert("Недопустипый размер файла "+h.name);return false}}}return true};a.prototype.bindEvents=function(){var e=this;this.input.bind({change:function(){e.addFiles(this.files)}});this.dropBox.on({dragenter:function(){d(this).addClass("uploader-widget-highlighted");return false},dragover:function(){return false},dragleave:function(){d(this).removeClass("uploader-widget-highlighted");return false},drop:function(h){var g=h.originalEvent.dataTransfer;e.addFiles(g.files);return false}});var f=this.form.find("[type='submit']");f.off("click");f.on("click",function(){var g=d(this).parents("form");if(e.hasInQueue(g[0])){if(e.validateFiles(g[0])){g.trigger("uploader.submit")}return false}return true});this.form.on("uploader.submit",function(l){var h=this;var g=0;var k=this.uploadQueue[e.inputName].length;if(k>0){d(this).find("[type='submit']").attr("disabled",true)}for(var j=0;j<k;j++){(function(o){var m=h.uploadQueue[e.inputName][o];var n=m.get(0).file;var p=[n];var q=new b({url:e.params.uploadUrl,files:p,fileName:e.inputName+"[]",progressCallback:function(r){if(r.lengthComputable){var i=Math.round(r.loaded/r.total*100);m.find(".uploader-widget-progress").width(i+"%")}},okCallback:function(){m.find(".uploader-file-name").val(this.responseText);g++;e.removeFromQueue(m.get(0));if(g==k){e.submitForm(h)}},errorCallback:function(){alert(this.responseText);d(h).find("[type='submit']").attr("disabled",false)}});q.upload()})(j)}return false});d("body").on("click",".uploader-file-remove",function(i){var g=d(this).parents("li");var h=d(this).parents("ul");e.removeFromQueue(g.get(0));g.remove();if(h.find("li").length==0){e.input.prev().val("")}i.preventDefault()})};a.prototype.removeFromQueue=function(f){var g=this.form.get(0).uploadQueue[this.inputName];for(var e in g){if(g[e].get(0)==f){g.splice(e,1)}}};a.prototype.addFiles=function(f){var e=this;d.each(f,function(m,l){var j=d("<li/>").appendTo(e.filesList);e.form.get(0).uploadQueue[e.inputName].push(j);var m=j.index();j.get(0).file=l;d('<div class="uploader-widget-name"></div>').text(l.name).appendTo(j);var h=d('<div class="uploader-widget-preview"></div>').appendTo(j);if(l.type.match(/image.*/)){var k=d("<img/>").appendTo(h);var g=new FileReader();g.onload=(function(i){return function(p){i.attr("src",p.target.result);i.attr("width",150)}})(k);g.readAsDataURL(l)}d("<div/>").addClass("uploader-widget-progress progress-bar").appendTo(j);var o=e.inputName+"["+m+"][file]";var n=e.inputName+"["+m+"][title]";d('<input type="hidden" name="'+o+'" value="" class="uploader-file-name" />').appendTo(j);d('<input type="text" name="'+n+'" value="" class="uploader-file-title" />').appendTo(j);d('<div><a href="#" class="uploader-file-remove">удалить</a></div>').appendTo(j)});if(f.length>0){this.input.prev().val(1)}};d.fn.html5Uploader=function(e){return this.each(function(){var f=new a(d(this),e);this.uploaderWidget=f})}})(jQuery);