(function(d){var c=function(e){this.params={size:0,ext:[]};d.extend(this.params,e)};c.prototype.getExt=function(f){var e=f.split(".");var g=e.pop();return g.toLowerCase()};c.prototype.validate=function(e){return this.validateSize(e)&&this.validateExt(e)};c.prototype.validateSize=function(e){if(this.params.size==0){return true}var f=this.params.size*1024*1024;if(e.size>f){return false}else{return true}};c.prototype.validateExt=function(e){var f=this.getExt(e.name);if(this.params.ext.length==0||d.inArray(f,this.params.ext)>-1){return true}else{return false}};var b=function(e){this.params=e};b.prototype.upload=function(){var h=this.params;var e=new XMLHttpRequest();if(e.upload&&e.upload.addEventListener){if(h.progressCallback){e.upload.addEventListener("progress",h.progressCallback,false)}e.onreadystatechange=function(){if(this.readyState==4){if(this.status==200){if(h.okCallback){h.okCallback.apply(this)}}else{if(h.errorCallback){h.errorCallback.apply(this)}}}};e.upload.addEventListener("error",function(i){alert("Ошибка при загрузке файла")})}var g=new FormData();g.append("path","/");for(var f=0;f<this.params.files.length;f++){g.append(this.params.fileName,this.params.files[f])}e.open("POST",this.params.url);e.send(g)};var a=function(e,f){this.params={uploadUrl:"/upload.php",maxFileSize:2,allowedExt:["jpg","jpeg","gif","png","pdf","doc","docx","xsl","xslx","odt","ppt","zip","rar","gz","tar","swf","csv"]};d.extend(this.params,f);this.input=e;this.form=e.parents("form");if(this.form.length==0){throw new Error("Виджет должен находится в форме")}if(!this.form.get(0).uploadQueue){this.form.get(0).uploadQueue=[]}this.inputName=this.input.attr("name");this.input.removeAttr("name");this.dropBox=e.next(".uploader-widget-drop-box");this.filesList=this.dropBox.find(".uploader-widget-files-list");this.bindEvents()};a.prototype.bindEvents=function(){var e=this;var f=new c({size:e.params.maxFileSize,ext:e.params.allowedExt});this.input.bind({change:function(){e.addFiles(this.files)}});this.dropBox.on({dragenter:function(){d(this).addClass("uploader-widget-highlighted");return false},dragover:function(){return false},dragleave:function(){d(this).removeClass("uploader-widget-highlighted");return false},drop:function(h){var g=h.originalEvent.dataTransfer;e.addFiles(g.files);return false}});this.form.off("submit");this.form.on("submit",function(n){if(this.uploadQueue.length==0){d(this).off("submit");d(this).submit();return true}var j=this;var h=0;var m=this.uploadQueue.length;for(var l=0;l<m;l++){var g=j.uploadQueue[l];var k=g.get(0).file;if(!f.validateExt(k)){alert("Недопустипый тип файла "+k.name);return false}if(!f.validateSize(k)){alert("Недопустипый размер файла "+k.name);return false}}d(this).find("[type='submit']").attr("disabled",true);for(var l=0;l<m;l++){(function(q){var o=j.uploadQueue[q];var p=o.get(0).file;var r=[p];var s=new b({url:e.params.uploadUrl,files:r,fileName:e.inputName+"[]",progressCallback:function(t){if(t.lengthComputable){var i=Math.round(t.loaded/t.total*100);o.find(".uploader-widget-progress").width(i+"%")}},okCallback:function(){o.find(".uploader-file-name").val(this.responseText);h++;e.removeFromQueue(o.get(0));if(h==m){d(j).trigger("submit")}if(q+1==m){d(j).find("input[type='submit']").attr("disabled",false)}},errorCallback:function(){alert(this.responseText);if(q+1==m){d(j).find("[type='submit']").attr("disabled",false)}}});s.upload()})(l)}return false});d("body").on("click",".uploader-file-remove",function(h){var g=d(this).parents("li");e.removeFromQueue(g.get(0));g.remove();h.preventDefault()})};a.prototype.removeFromQueue=function(f){if(!this.form.get(0).uploadQueue){return}var g=this.form.get(0).uploadQueue;for(var e in g){if(g[e].get(0)==f){g.splice(e,1)}}};a.prototype.addFiles=function(f){var e=this;d.each(f,function(m,l){var j=d("<li/>").appendTo(e.filesList);e.form.get(0).uploadQueue.push(j);var m=j.index();j.get(0).file=l;d('<div class="uploader-widget-name"></div>').text(l.name).appendTo(j);var h=d('<div class="uploader-widget-preview"></div>').appendTo(j);if(l.type.match(/image.*/)){var k=d("<img/>").appendTo(h);var g=new FileReader();g.onload=(function(i){return function(p){i.attr("src",p.target.result);i.attr("width",150)}})(k);g.readAsDataURL(l)}d("<div/>").addClass("uploader-widget-progress progress-bar").appendTo(j);var o=e.inputName+"["+m+"][file]";var n=e.inputName+"["+m+"][title]";d('<input type="hidden" name="'+o+'" value="" class="uploader-file-name" />').appendTo(j);d('<input type="text" name="'+n+'" value="" class="uploader-file-title" />').appendTo(j);d('<div><a href="#" class="uploader-file-remove">удалить</a></div>').appendTo(j)})};d.fn.html5Uploader=function(e){return this.each(function(){var f=new a(d(this),e);this.uploaderWidget=f})}})(jQuery);