(function(a){a.fn.commentsWidget=function(){return this.each(function(){var i=a(this);var e=i.find("form");var d=i.find("textarea");var b=i.attr("id");var h=function(){i.find(".comments-ok").hide();i.find(".comments-error").show()};var g=function(l){i.find(".comments-ok").show();i.find(".comments-error").hide();var k="pjax-"+b;a(document).on("pjax:end",function(){c(l);a(document).off("pjax:end")});a.pjax.reload({container:"#"+k,timeout:false});d.val("");i.find(".comments-re-cancel").trigger("click");e.yiiActiveForm("resetForm");var j=e.yiiActiveForm("data");j.validated=false};var c=function(l){var j=a("#comments-item-"+l);if(j.length>0){var k=j.offset().top;a(window).scrollTop(k)}};a("body").on("click","#"+b+" .comments-re-link",function(){var k=a(this).data("id");var j=a(this).data("username");i.find("input[name='parent_id']").val(k);i.find(".comments-re-wrapper").show();i.find(".comments-re-info").html(j)});a("body").on("click","#"+b+" .comments-quote-link",function(){var k=a(this).data("id");var j=a(this).parents(".comments-item").find(".comments-body").text();d.markItUp("insert",{openWith:"[quote]",closeWith:"[/quote]",placeHolder:a.trim(j)})});i.find(".comments-re-cancel").on("click",function(j){i.find("input[name='parent_id']").val(0);i.find(".comments-re-wrapper").hide();i.find(".comments-re-info").html("");j.preventDefault()});var f=false;e.on("submit",function(){var j=a(this);var k=j.data("yiiActiveForm");k.settings.beforeSubmit=function(){j.trigger("beforeSubmit")};return false});e.on("beforeSubmit",function(l){l.preventDefault();if(f){return}f=true;var k=e.attr("action");var j=a.ajax({url:k,type:"post",data:e.serialize(),headers:{},dataType:"json",success:function(n,m,o){if(o.status==201){g(n.id)}else{h()}},error:function(){h()}});j.always(function(){f=false})})})}})(jQuery);