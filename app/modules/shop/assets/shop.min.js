(function(e,n){var g=e.module("shopModule",[]);g.value("urlMapping",{add:"/shop/basket-rest/add/",del:"/shop/basket-rest/delete/",update:"/shop/basket-rest/update/",stat:"/shop/basket-rest/stat/",order:"/shop/basket-rest/order/",setOrder:"/shop/basket-rest/set-order/",payments:"/shop/basket-rest/payments/",deliveries:"/shop/basket-rest/deliveries/",confirm:"/shop/basket-rest/confirm/"});g.service("basketNotifier",["shopMessages",function(c){this.addNotify=function(){alert(c.addedToCart)}}]);g.service("shopBasket",
["$http","urlMapping","basketNotifier",function(c,f,g){var b=this,k={};this.getStat=function(a){(e.equals(k,{})||a)&&c.get(f.stat).success(function(a){e.extend(k,a)});return k};this.setStat=function(a){e.extend(k,a)};this.add=function(a,d,h){c.post(f.add,{id:a,"class":d,qty:h}).success(function(a){g.addNotify();b.setStat(a)})};var m={};this.hasOrderLoaded=!1;this.getOrder=function(a){this.hasOrderLoaded&&!a||c.get(f.order).success(function(a){e.extend(m,a);b.hasOrderLoaded=!0});return m};this.setOrder=
function(a){e.extend(m,a)};this.inOrder=function(a,d,h){if(!a.allGoods)return!1;for(var l in a.allGoods){var b=a.allGoods[l];if(b.item_id==d&&b.item_class==h)return!0}return!1};this.del=function(a,d){c.delete(f.del,{params:{id:a,"class":d}}).success(function(a){b.setOrder(a);b.getStat(!0)})};this.update=function(a,d,h){c.put(f.update,{qty:h},{params:{id:a,"class":d}}).success(function(a){b.setOrder(a);b.getStat(!0)})};this.syncOrder=function(){c.put(f.setOrder,{Order:this.getOrder()}).success(function(a){b.setOrder(a)})};
this.loadIfNotEmpty=function(a,d,b){e.equals(d,{})&&c.get(a).success(function(a){e.extend(d,a);b&&b(a)})};this.getFirstKey=function(a){for(var b in a)return b;return null};this.findObject=function(a,b,c){for(var l in a)if(a[l][b]==c)return a[l];return null};this.clearObject=function(a){for(var b in a)delete a[b]};this.getDeliveries=function(){var a=b.getOrder();!a.delivery_id&&0<a.deliveries.length&&(a.delivery_id=a.deliveries[0].id,b.syncOrder());return a.deliveries};this.getPayments=function(){var a=
b.getOrder();!a.payment_id&&0<a.payments.length&&(a.payment_id=a.payments[0].id);return a.payments};this.confirmOrder=function(a,d){var e=function(a){d(a);b.getOrder(!0)};c.post(f.confirm,{Order:this.getOrder()}).success(function(c,d){201==d?(a(c),b.setStat({count:0,summ:0}),b.clearObject(m)):e(c)}).error(e)}}])})(angular,jQuery);
